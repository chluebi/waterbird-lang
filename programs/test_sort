binary_search(x, min, max, comp=|x,y|{x-y}, key=|x|{x}) {
    if comp(key(min), x) == 0 {
        return min;
    }

    guess = min + (max - min) / 2;

    
    while true {
        diff = comp(key(guess), x);

        if diff == 0 {
            return guess;
        } else if diff < 0 {
            min = guess + 1;
            if min > max {
                return guess;
            }
        } else {
            max = guess - 1;
            if max < min {
                return guess-1;
            }
        }
        guess = min + (max - min) / 2;
    }
}

binary_search_list(l, x, min, max, comp=|x,y|{x-y}) {
    binary_search(x, min, max, comp=comp, key=|x|{l[x]})
}

sort(l, key=|x|{x}) {

    for i in range(1, len(l)) {
        current_value = l[i];
        current_key = key(current_value);
        j = i - 1;

        min = 0;
        max = j;

        index = binary_search_list(l, current_key, min, max, comp=|x,y|{key(x)-y}) + 1;

        while j >= index {
            l[j+1] = l[j];
            j = j - 1;
        }

        l[j+1] = current_value;
    }
    
    return l;
}



comp_sort(l, key=|x,y|{x-y}) {

    for i in range(1, len(l)) {
        current_value = l[i];
        j = i - 1;

        min = 0;
        max = j;

        index = binary_search_list(l, current_value, min, max, comp=|x,y|{key(x,y)}) + 1;

        while j >= index {
            l[j+1] = l[j];
            j = j - 1;
        }

        l[j+1] = current_value;
    }
    
    return l;
}


main() {
    assert(binary_search_list([1, 2, 3, -1, 5, 42], 2, 0, 2) == 1);
    assert(sort([2, -1, 4, 1]) == [-1, 1, 2, 4]);
    assert(sort([-3, -2, -1]) == [-3, -2, -1]);
    assert(sort([-3, -2, -1], key=|x|{-x}) == [-1, -2, -3]);
    assert(comp_sort([-3, -2, -1], key=|x,y|{x-y}) == [-3, -2, -1]);
    assert(comp_sort([-3, -2, -1], key=|x,y|{y-x}) == [-1, -2, -3]);
    assert(comp_sort(["a", "bb", "ccc"], key=|x,y|{len(x) - len(y)}) == ["a", "bb", "ccc"]);
    assert(comp_sort(["a", "bb", "ccc"], key=|x,y|{
        if ("b" in x) && !("b" in y) {
            return -1;
        } else if !("b" in x) && ("b" in y) {
            return 1;
        } else {
            return len(x) - len(y);
        }
        return 0;
    }) == ["bb", "a", "ccc"]);
}